// controller/image.controller.js

import { GoogleGenAI } from '@google/genai';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import dotenv from 'dotenv';

dotenv.config();

// Get directory name in ES modules
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Create temp directory for storing images if it doesn't exist
const tempDir = path.join(__dirname, '..', 'temp');
if (!fs.existsSync(tempDir)) {
  fs.mkdirSync(tempDir, { recursive: true });
}

// Gemini API key
const GEMINI_API_KEY = process.env.GEMINI_API_KEY;

// Generate image controller
export const generateImage = async (req, res) => {
  try {
    const { prompt } = req.body;
    
    if (!prompt) {
      return res.status(400).json({ 
        success: false, 
        message: 'Please provide an image prompt' 
      });
    }

    // Initialize Google Gemini API
    const ai = new GoogleGenAI({ apiKey: GEMINI_API_KEY });

    console.log(`Generating image for prompt: "${prompt}"`);

    // Get the Modality enum from the package
    const { Modality } = await import('@google/genai');

    // Generate image
    const response = await ai.models.generateContent({
      model: "gemini-2.0-flash-preview-image-generation",
      contents: prompt,
      config: {
        responseModalities: [Modality.TEXT, Modality.IMAGE],
      },
    });

    let imageFilename = null;
    let responseText = null;

    // Process response
    for (const part of response.candidates[0].content.parts) {
      if (part.text) {
        responseText = part.text;
      } else if (part.inlineData) {
        // Save the image
        const imageData = part.inlineData.data;
        const buffer = Buffer.from(imageData, "base64");
        
        // Create unique filename with timestamp and a random component for uniqueness
        imageFilename = `gemini-${Date.now()}-${Math.floor(Math.random() * 1000)}.png`;
        const imagePath = path.join(tempDir, imageFilename);
        
        fs.writeFileSync(imagePath, buffer);
        console.log(`Image saved as ${imagePath}`);
      }
    }

    if (!imageFilename) {
      return res.status(500).json({
        success: false,
        message: 'No image was generated by the API'
      });
    }

    // The URL that the frontend should use to fetch the image
    const imageUrl = `/image/${imageFilename}`;
    
    console.log(`Sending image URL to client: ${imageUrl}`);

    // Return response
    res.status(200).json({
      success: true,
      prompt,
      message: responseText || 'Image generated successfully',
      imageUrl: imageUrl
    });

  } catch (error) {
    console.error('Error generating image:', error);
    res.status(500).json({ 
      success: false, 
      message: 'Error generating image', 
      error: error.message 
    });
  }
};